name: Sync to public repo and create release

on:
  push:
    branches:
      - main
    paths:
      - 'docker-compose.prod.yml'
      - 'frontend/**'
      - 'backend/**'
  release:
    types: [published]

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source (private) repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(jq -r '.version' frontend/package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # Create a unique tag with timestamp for each commit
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "tag=v${VERSION}-${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Get commit message
        id: commit
        run: |
          # Get the commit message, escape for JSON
          MSG=$(git log -1 --pretty=format:"%s" | sed 's/"/\\"/g')
          BODY=$(git log -1 --pretty=format:"%b" | sed 's/"/\\"/g' | tr '\n' ' ')
          echo "message=$MSG" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT

      - name: Checkout target (public) repo
        uses: actions/checkout@v4
        with:
          repository: HZMonama/regolab-self-host
          token: ${{ secrets.PUBLIC_REPO_PAT }}
          path: public
          fetch-depth: 0

      - name: Copy prod compose file into public repo
        run: |
          mkdir -p public
          cp docker-compose.prod.yml public/docker-compose.prod.yml

      - name: Commit and push if changed
        working-directory: public
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add docker-compose.prod.yml
            git commit -m "Sync docker-compose.prod.yml from regolab @${GITHUB_SHA::7}"
            git push origin HEAD:main
            echo "Pushed updated docker-compose.prod.yml to regolab-self-host"
          else
            echo "No changes to commit"
          fi

      - name: Create release on public repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PUBLIC_REPO_PAT }}
          script: |
            const version = '${{ steps.version.outputs.tag }}';
            const shortSha = '${{ steps.version.outputs.short_sha }}';
            const commitMessage = `${{ steps.commit.outputs.message }}`;
            const commitBody = `${{ steps.commit.outputs.body }}`;
            
            const releaseBody = `## Changes

            ${commitMessage}

            ${commitBody ? `### Details\n${commitBody}` : ''}

            ---
            
            ðŸ“¦ **Docker Images:**
            - \`ghcr.io/hzmonama/regolab-frontend:latest\`
            - \`ghcr.io/hzmonama/regolab-backend:latest\`
            
            ðŸ”— Synced from private repo commit: \`${shortSha}\`
            
            ### Quick Start
            \`\`\`bash
            curl -O https://raw.githubusercontent.com/HZMonama/regolab-self-host/main/docker-compose.prod.yml
            docker compose -f docker-compose.prod.yml up -d
            \`\`\`
            `;
            
            try {
              await github.rest.repos.createRelease({
                owner: 'HZMonama',
                repo: 'regolab-self-host',
                tag_name: version,
                name: `RegoLab ${version}`,
                body: releaseBody,
                draft: false,
                prerelease: false,
              });
              console.log(`Created release ${version}`);
            } catch (error) {
              console.error('Failed to create release:', error);
              // Don't fail the workflow if release creation fails
            }